
<!-- TODO: Look to see if any attendances for the day have already been set
and set them on the page visually. When the professor submits, submit
every possible attendance, new and modified, to the database. -->

<style type="text/css">

#students_container > div {
  float: left;
}

.student {
  color: #ff0000;
  background-color: #ccc;
  font-weight: bold;
  border: 1px solid #000;
  margin: 0px 10px 10px 0px;
  width: 122px;
  height: 122px;
  text-align: center;
}

.student_name {
  width: auto;
  background-color: #000;
}

.last {
  margin-right: 0px !important;
}

.present {
  background-image: url('http://i293.photobucket.com/albums/mm55/SqueakyMachine/cake-2-1.jpg');
}

.absent {
  background-image: url('http://i293.photobucket.com/albums/mm55/SqueakyMachine/105ac7f7-3730-4dc8-8e06-a27298eb92c8.jpg');
}

.tardy {
  background-image: url('http://i293.photobucket.com/albums/mm55/SqueakyMachine/1164044a-eb49-416b-8ec4-7c03d32a5a96.jpg');
}

.excused {
  background-image: url('http://i293.photobucket.com/albums/mm55/SqueakyMachine/f52bded2-e0d5-4b55-bb50-f59e6eac425a.jpg');
}

</style>

<script type="text/javascript">

// Example output: Notice the keys for the attendance hash are the user ids, and the
// attendance hash consists of the already set attendance values for the section
// on this date. Whenever the professor submits this data, the data in the attendances
// hash is what needs to be sent to the server.

// var data = {
//   section_id: 1,
//   class_date: "2013-04-15",
//   attendance: {
//     "7": { user_name: "student2", attendance: 1 },
//     "9": { user_name: "student4", attendance: 2 }
//   },
//   students: [
//     { user_name: "student2", user_id: 7 },
//     { user_name: "student4", user_id: 9 }
//   ],
//   images: {
//     ...
//   }
// };

var data = {
  <%= raw attendance_json %>
  images: {
    present: 'http://i293.photobucket.com/albums/mm55/SqueakyMachine/cake-2-1.jpg',
    absent:  'http://i293.photobucket.com/albums/mm55/SqueakyMachine/105ac7f7-3730-4dc8-8e06-a27298eb92c8.jpg',
    tardy:   'http://i293.photobucket.com/albums/mm55/SqueakyMachine/1164044a-eb49-416b-8ec4-7c03d32a5a96.jpg',
    excused: 'http://i293.photobucket.com/albums/mm55/SqueakyMachine/f52bded2-e0d5-4b55-bb50-f59e6eac425a.jpg'
  }
};

// Displays the students when the page loads
function display_students() {
  $.each(data.students, function() {
    var student = $('<div class="student"></div>')
      .html('<div class="student_name">' + this.user_name + '</div>')
      .data('user_id', this.user_id)
      .css({opacity: 0.9 })
      .hover(function() {
          $(this).css({opacity: 1.0 })
        },
        function() {
          $(this).css({opacity: 0.9 })
        }
      )
      .click(function() {

        // Rotate image
        if($(this).hasClass('present')) {
          $(this).removeClass('present').addClass('absent');
        }
        else if($(this).hasClass('absent')) {
          $(this).removeClass('absent').addClass('tardy');
        }
        else if($(this).hasClass('tardy')) {
          $(this).removeClass('tardy').addClass('excused');
        }
        else {
          $(this).removeClass('excused').addClass('present');
        }

        // Update JSON
        var user_id = $(this).data('user_id');
      });

      // If an attendance value has already been set for this student on this date
      if(data.attendance.hasOwnProperty(this.user_id.toString())) {
        var attendance_value = data.attendance[this.user_id.toString()].attendance;

        switch(attendance_value) {
          case 1: student.addClass('present'); break;
          case 2: student.addClass('absent'); break;
          case 3: student.addClass('tardy'); break;
          case 4: student.addClass('excused'); break;
        }
      }
      else {
        student.addClass('present');
      }

    $('#students_container').append(student);
  });
}

// Preload the attendance images so there isn't a slight hesitation when
// the professor clicks on a student and the next image has to load.
function preload_images() {
  for(var key in data.images) {
    new Image().src = data.images[key];
  }
}

function add_event_handlers() {
  $('input[name="update"]').click(function() {
    alert('Send JSON response @ attendances/send?date=2013-04-14&section=1');
  });
}

$(document).ready(function() {
  preload_images();
  add_event_handlers();
  display_students();
});

</script>

Course: <%= Course.find_name_by_section_id(params[:section]) %><br />
Section: <%= Section.find_number_by_section_id(params[:section]) %><br />
Date: <%= format_date_from_url(params[:date]) %><br /><br />

Professor: <%= output_user_list(@professors) %><br />
TA: <%= output_user_list(@tas) %><br /><br />

<div id="students_container"></div>

<br style="clear: both;" />
<br />

<input type="button" name="update" value="Update Attendance" />

<br />